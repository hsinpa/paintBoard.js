var pinBoard=function(a){function b(a,b){var c=a.getBoundingClientRect();return{x:b.clientX-c.left,y:b.clientY-c.top}}function c(){d.on("click","button",function(){switch(a(this).attr("functionality")){case"backward":p.backward();break;case"trashcan":p.trashcan();break;case"download":p.download();break;case"upload":a("input[type=file]").trigger("click");break;default:m=a(this).attr("functionality")}}),d.on("change","input[type=file]",function(){p.upload(this.files[0])}),d.on("mouseup","input[type=range]",function(){k=a(this).val()}),d.on("click",".pinBoard-color li",function(){l=a(this).attr("value"),a(".pinBoard-color li").css("border","none"),a(this).css("border-right","5px solid black")}),d.on("mousedown","canvas",function(c){var e=b(this,c);switch(m){case"pin":p.createPin(e.x,e.y,l),i.push({x:e.x,y:e.y,color:l});break;case"pencil":isDown=!0,f.lineWidth=k,f.lineCap="round",f.beginPath(),f.moveTo(e.x,e.y),j.push([{x:e.x,y:e.y,color:l,lineWidth:k}]),d.on("mousemove","canvas",function(a){if(isDown){var c=j.length-1;e=b(this,a),f.lineTo(e.x,e.y),f.strokeStyle=l,f.stroke(),j[c].push({x:e.x,y:e.y})}}),a(document).on("mouseup",function(){isDown=!1,f.closePath()})}})}var d,e,f,g,h,i=[],j=[],k=1,l="#2ecc71",m="pencil",n=["#2ecc71","#27ae60","#3498db","#2980b9","#9b59b6","#8e44ad","#f1c40f","#f39c12","#e67e22","#d35400","#e74c3c","#c0392b","#34495e","#ecf0f1","#bdc3c7","#95a5a6","#7f8c8d"],o={colorOptions:function(){for(var a="",b=0;b<n.length;b++)a+='<li value="'+n[b]+'" style="background-color:'+n[b]+';">&nbsp;</li>';return a},toolTemplate:function(){var a="";return a+='<div><button functionality="pin"></button><button functionality="pencil"></button><button functionality="backward"></button><button functionality="trashcan"></button><button functionality="download"></button><button functionality="upload"></button><input type="file"><input type="range" min="1" max="10" value="1" /><ul class="pinBoard-color">',a+=this.colorOptions(),a+="</ul></div>"},canvasTemplate:function(){return'<canvas width="'+h+'" height="'+g+'"></canvas>'},buildCanvas:function(){d.append(this.toolTemplate()),d.append(this.canvasTemplate()),e=d.find("canvas"),f=e[0].getContext("2d")}},p={createPin:function(a,b,c){f.save(),f.translate(a,b),f.beginPath(),f.moveTo(0,0),f.bezierCurveTo(2,-10,-20,-25,0,-30),f.bezierCurveTo(20,-25,-2,-10,0,0),f.fillStyle=c,f.fill(),f.strokeStyle="black",f.lineWidth=.5,f.stroke(),f.beginPath(),f.arc(0,-21,3,0,2*Math.PI),f.closePath(),f.fillStyle="black",f.fill(),f.restore()},createPencil:function(a){var b=a.length;f.lineCap="round",f.lineWidth=a[0].lineWidth,f.beginPath(),f.moveTo(a[0].x,a[0].y);for(var c=1;b>c;c++)f.lineTo(a[c].x,a[c].y);f.strokeStyle=a[0].color,f.stroke()},reDraw:function(){f.clearRect(0,0,h,g);for(var a=i.length,b=j.length,c=0;a>c;c++)this.createPin(i[c].x,i[c].y,i[c].color);for(var c=0;b>c;c++)this.createPencil(j[c])},backward:function(){"pin"===m?(i.pop(),this.reDraw()):(j.pop(),this.reDraw())},trashcan:function(){f.clearRect(0,0,h,g),i=[],j=[]},download:function(){window.location=e[0].toDataURL("image/png")},upload:function(a){var b=new FileReader,c=new Image;b.readAsDataURL(a),b.onload=function(a){c.src=a.target.result,c.onload=function(){f.drawImage(c,0,0,h,g)}}}};return function(b){d=a(b),d&&0!=d.length&&(g=d.height(),h=d.width(),d.css("height",g),d.css("width",h+45),o.buildCanvas(),c())}}(jQuery);
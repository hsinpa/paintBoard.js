var pinBoard=function(a){function b(a,b){var c=a.getBoundingClientRect();return{x:b.clientX-c.left,y:b.clientY-c.top}}var c,d,e,f,g,h=[],i=[],j=1,k="#2ecc71",l="pencil",m=["#2ecc71","#27ae60","#3498db","#2980b9","#9b59b6","#8e44ad","#f1c40f","#f39c12","#e67e22","#d35400","#e74c3c","#c0392b","#34495e","#ecf0f1","#bdc3c7","#95a5a6","#7f8c8d"],n={colorOptions:function(){for(var a="",b=0;b<m.length;b++)a+='<li value="'+m[b]+'" style="background-color:'+m[b]+';">&nbsp;</li>';return a},toolTemplate:function(){var a="";return a+='<div><button functionality="pin"></button><button functionality="pencil"></button><button functionality="backward"></button><button functionality="trashcan"></button><button functionality="download"></button><button functionality="upload"></button><input type="file"><input type="range" min="1" max="10" value="1" /><ul class="pinBoard-color">',a+=this.colorOptions(),a+="</ul></div>"},canvasTemplate:function(){return'<canvas width="'+g+'" height="'+f+'"></canvas>'},buildCanvas:function(){c.append(this.toolTemplate()),c.append(this.canvasTemplate()),d=c.find("canvas"),e=d[0].getContext("2d")}};a(function(){c&&(c.on("click","button",function(){switch(a(this).attr("functionality")){case"backward":o.backward();break;case"trashcan":o.trashcan();break;case"download":o.download();break;case"upload":a("input[type=file]").trigger("click");break;default:l=a(this).attr("functionality")}}),c.on("change","input[type=file]",function(){o.upload(this.files[0])}),c.on("mouseup","input[type=range]",function(){j=a(this).val()}),c.on("click",".pinBoard-color li",function(){k=a(this).attr("value"),a(".pinBoard-color li").css("border","none"),a(this).css("border-right","5px solid black")}),c.on("mousedown","canvas",function(d){var f=b(this,d);switch(l){case"pin":o.createPin(f.x,f.y,k),h.push({x:f.x,y:f.y,color:k});break;case"pencil":isDown=!0,e.lineWidth=j,e.lineCap="round",e.beginPath(),e.moveTo(f.x,f.y),i.push([{x:f.x,y:f.y,color:k,lineWidth:j}]),c.on("mousemove","canvas",function(a){if(isDown){var c=i.length-1;f=b(this,a),e.lineTo(f.x,f.y),e.strokeStyle=k,e.stroke(),i[c].push({x:f.x,y:f.y})}}),a(document).on("mouseup",function(){isDown=!1,e.closePath()})}}))});var o={createPin:function(a,b,c){e.save(),e.translate(a,b),e.beginPath(),e.moveTo(0,0),e.bezierCurveTo(2,-10,-20,-25,0,-30),e.bezierCurveTo(20,-25,-2,-10,0,0),e.fillStyle=c,e.fill(),e.strokeStyle="black",e.lineWidth=.5,e.stroke(),e.beginPath(),e.arc(0,-21,3,0,2*Math.PI),e.closePath(),e.fillStyle="black",e.fill(),e.restore()},createPencil:function(a){var b=a.length;e.lineCap="round",e.lineWidth=a[0].lineWidth,e.beginPath(),e.moveTo(a[0].x,a[0].y);for(var c=1;b>c;c++)e.lineTo(a[c].x,a[c].y);e.strokeStyle=a[0].color,e.stroke()},reDraw:function(){e.clearRect(0,0,g,f);for(var a=h.length,b=i.length,c=0;a>c;c++)this.createPin(h[c].x,h[c].y,h[c].color);for(var c=0;b>c;c++)this.createPencil(i[c])},backward:function(){"pin"===l?(h.pop(),this.reDraw()):(i.pop(),this.reDraw())},trashcan:function(){e.clearRect(0,0,g,f),h=[],i=[]},download:function(){window.location=d[0].toDataURL("image/png")},upload:function(a){var b=new FileReader,c=new Image;b.readAsDataURL(a),b.onload=function(a){c.src=a.target.result,c.onload=function(){e.drawImage(c,0,0,g,f)}}}};return function(b){c=a(b),f=c.height(),g=c.width(),c.css("height",f),c.css("width",g+45),n.buildCanvas()}}(jQuery);